<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.reinforce.web.fly.dao.FateRequestMapper">
    <resultMap id="BaseResultMap" type="cn.reinforce.web.fly.model.http.FateRequest">
        <id column="requestId" jdbcType="VARCHAR" property="requestId"/>
        <result column="agent" jdbcType="VARCHAR" property="agent"/>
        <result column="error" jdbcType="BIT" property="error"/>
        <result column="ip" jdbcType="VARCHAR" property="ip"/>
        <result column="klass" jdbcType="VARCHAR" property="klass"/>
        <result column="method" jdbcType="VARCHAR" property="method"/>
        <result column="request_time" jdbcType="TIMESTAMP" property="requestTime"/>
        <result column="source" jdbcType="VARCHAR" property="source"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="timestamp" jdbcType="BIGINT" property="timestamp"/>
        <result column="uid" jdbcType="VARCHAR" property="uid"/>
        <result column="username" jdbcType="VARCHAR" property="username"/>
        <result column="area" jdbcType="VARCHAR" property="area"/>
        <result column="count" jdbcType="INTEGER" property="count"/>
        <result column="operator" jdbcType="VARCHAR" property="operator"/>
        <result column="queries" jdbcType="LONGVARCHAR" property="queries"/>
        <result column="referer" jdbcType="LONGVARCHAR" property="referer"/>
        <result column="result" jdbcType="LONGVARCHAR" property="result"/>
        <result column="url" jdbcType="LONGVARCHAR" property="url"/>
        <result column="associate_id" jdbcType="VARCHAR" property="associateId"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
    </resultMap>

    <resultMap id="pie" type="cn.reinforce.web.fly.model.http.FateRequestPieView">
        <id column="c" jdbcType="BIGINT" property="count"/>
        <result column="time" jdbcType="VARCHAR" property="time"/>
    </resultMap>
    <sql id="Base_Column_List">
        requestId, agent, error, ip, klass, method, request_time, source, status, timestamp,
        uid, username, area, count, operator, queries, referer, result, url, associate_id, type
      </sql>
    <sql id="Ex_Column_List">
        r.requestId, agent, error, ip, klass, method, request_time, source, status, timestamp,
        uid, username, area, count, operator, queries, referer, result, url, associate_id, type
    </sql>
    <select id="find" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from fly_request
        where requestId = #{requestId,jdbcType=VARCHAR}
    </select>

    <select id="page" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from fly_request
        where error = #{error,jdbcType=BIT}
        <if test="name != null and name != ''">
            and username=#{name,jdbcType=VARCHAR}
        </if>
        <if test="startTime != null and startTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')>=#{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime != null and endTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')&lt;=#{endTime,jdbcType=VARCHAR}
        </if>
        <if test="url != null and url != ''">
            and url like CONCAT('%', #{url,jdbcType=VARCHAR},'%')
        </if>
        order by request_time desc limit #{start,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
    </select>

    <select id="count" resultType="java.lang.Long">
        select count(requestId) from fly_request
        where error = #{error,jdbcType=BIT}
        <if test="name != null and name != ''">
            and username=#{name,jdbcType=VARCHAR}
        </if>
        <if test="startTime != null and startTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')>=#{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime != null and endTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')&lt;=#{endTime,jdbcType=VARCHAR}
        </if>
        <if test="url != null and url != ''">
            and url like CONCAT('%', #{url,jdbcType=VARCHAR},'%')
        </if>
    </select>

    <select id="searchNot" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from fly_request
        where error = #{error,jdbcType=BIT}
        <if test="name != null and name != ''">
            and username=#{name,jdbcType=VARCHAR}
        </if>
        <if test="startTime != null and startTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')>=#{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime != null and endTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')&lt;=#{endTime,jdbcType=VARCHAR}
        </if>
        <if test="url != null and url != ''">
            and url not like CONCAT('%', #{url,jdbcType=VARCHAR},'%')
        </if>
        order by request_time desc limit #{start,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
    </select>

    <select id="countNot" resultType="java.lang.Long">
        select count(requestId) from fly_request
        where error = #{error,jdbcType=BIT}
        <if test="name != null and name != ''">
            and username=#{name,jdbcType=VARCHAR}
        </if>
        <if test="startTime != null and startTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')>=#{startTime,jdbcType=VARCHAR}
        </if>
        <if test="endTime != null and endTime != ''">
            and DATE_FORMAT(request_time,'%Y-%m-%d')&lt;=#{endTime,jdbcType=VARCHAR}
        </if>
        <if test="url != null and url != ''">
            and url not like CONCAT('%', #{url,jdbcType=VARCHAR},'%')
        </if>
    </select>

    <select id="searchError" resultMap="BaseResultMap">
        select
        <include refid="Ex_Column_List"/>
        from fly_request r, (select requestId from fly_request where status>=400 order by request_time desc limit
        #{start,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}) r2 where r.requestId =r2.requestId
    </select>

    <select id="countError" resultType="java.lang.Long">
        select count(f.requestId) from fly_request f where f.status>=400
    </select>

    <select id="searchAreaBlank" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from fly_request where area is null order by request_time asc limit
        #{start,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
    </select>

    <select id="statisticsLoginTime" resultMap="pie">
        SELECT COUNT(requestId) c,DATE_FORMAT(request_time,'%H') time FROM logging_request WHERE url LIKE '%op/login%' GROUP BY TIME
    </select>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from fly_request
    where requestId = #{requestId,jdbcType=VARCHAR}
  </delete>
    <insert id="save" parameterType="cn.reinforce.web.fly.model.http.FateRequest">
        <selectKey keyProperty="requestId" order="BEFORE" resultType="java.lang.String">
            SELECT uuid()
        </selectKey>
        insert into fly_request (requestId, agent, error,
        ip, klass, method,
        request_time, source, status,
        timestamp, uid, username,
        area, count, operator,
        queries, referer, result,
        url, associate_id, type)
        values (#{requestId}, #{agent,jdbcType=VARCHAR}, #{error,jdbcType=BIT},
        #{ip,jdbcType=VARCHAR}, #{klass,jdbcType=VARCHAR}, #{method,jdbcType=VARCHAR},
        #{requestTime,jdbcType=TIMESTAMP}, #{source,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER},
        #{timestamp,jdbcType=BIGINT}, #{uid,jdbcType=VARCHAR}, #{username,jdbcType=VARCHAR},
        #{area,jdbcType=VARCHAR}, #{count,jdbcType=INTEGER}, #{operator,jdbcType=VARCHAR},
        #{queries,jdbcType=LONGVARCHAR}, #{referer,jdbcType=LONGVARCHAR}, #{result,jdbcType=LONGVARCHAR},
        #{url,jdbcType=LONGVARCHAR},#{associateId,jdbcType=VARCHAR},#{type,jdbcType=INTEGER})
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="cn.reinforce.web.fly.model.http.FateRequest">
        update fly_request
        <set>
            <if test="agent != null">
                agent = #{agent,jdbcType=VARCHAR},
            </if>
            <if test="error != null">
                error = #{error,jdbcType=BIT},
            </if>
            <if test="ip != null">
                ip = #{ip,jdbcType=VARCHAR},
            </if>
            <if test="klass != null">
                klass = #{klass,jdbcType=VARCHAR},
            </if>
            <if test="method != null">
                method = #{method,jdbcType=VARCHAR},
            </if>
            <if test="requestTime != null">
                request_time = #{requestTime,jdbcType=TIMESTAMP},
            </if>
            <if test="source != null">
                source = #{source,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
            <if test="timestamp != null">
                timestamp = #{timestamp,jdbcType=BIGINT},
            </if>
            <if test="uid != null">
                uid = #{uid,jdbcType=VARCHAR},
            </if>
            <if test="username != null">
                username = #{username,jdbcType=VARCHAR},
            </if>
            <if test="area != null">
                area = #{area,jdbcType=VARCHAR},
            </if>
            <if test="count != null">
                count = #{count,jdbcType=INTEGER},
            </if>
            <if test="operator != null">
                operator = #{operator,jdbcType=VARCHAR},
            </if>
            <if test="queries != null">
                queries = #{queries,jdbcType=LONGVARCHAR},
            </if>
            <if test="referer != null">
                referer = #{referer,jdbcType=LONGVARCHAR},
            </if>
            <if test="result != null">
                result = #{result,jdbcType=LONGVARCHAR},
            </if>
            <if test="url != null">
                url = #{url,jdbcType=LONGVARCHAR},
            </if>
            <if test="associateId != null">
                associate_id = #{associateId,jdbcType=VARCHAR},
            </if>
            <if test="type != 0">
                type = #{type,jdbcType=INTEGER}
            </if>
        </set>
        where requestId = #{requestId,jdbcType=VARCHAR}
    </update>
    <update id="update" parameterType="cn.reinforce.web.fly.model.http.FateRequest">
    update fly_request
    set agent = #{agent,jdbcType=VARCHAR},
      error = #{error,jdbcType=BIT},
      ip = #{ip,jdbcType=VARCHAR},
      klass = #{klass,jdbcType=VARCHAR},
      method = #{method,jdbcType=VARCHAR},
      request_time = #{requestTime,jdbcType=TIMESTAMP},
      source = #{source,jdbcType=VARCHAR},
      status = #{status,jdbcType=INTEGER},
      timestamp = #{timestamp,jdbcType=BIGINT},
      uid = #{uid,jdbcType=VARCHAR},
      username = #{username,jdbcType=VARCHAR},
      area = #{area,jdbcType=VARCHAR},
      count = #{count,jdbcType=INTEGER},
      operator = #{operator,jdbcType=VARCHAR},
      queries = #{queries,jdbcType=LONGVARCHAR},
      referer = #{referer,jdbcType=LONGVARCHAR},
      result = #{result,jdbcType=LONGVARCHAR},
      url = #{url,jdbcType=LONGVARCHAR},
      associate_id = #{associateId,jdbcType=VARCHAR},
      type = #{type,jdbcType=INTEGER}
    where requestId = #{requestId,jdbcType=VARCHAR}
  </update>

    <update id="updateArea" parameterType="java.lang.String">
        update fly_request set area=#{area}, operator=#{operator} where ip=#{ip} and DATE_FORMAT(request_time, '%Y-%m-%d %T')>=#{requestTime}
    </update>
</mapper>